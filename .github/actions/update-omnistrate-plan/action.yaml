name: Update Omnistrate Plan
description: "Update an Omnistrate plan with a new compose file"

inputs:
  username:
    description: "The username to use for authentication"
    required: true
  password:
    description: "The password to use for authentication"
    required: true
  file:
    description: "The file to update the plan with"
    required: true
  service-name:
    description: "The name of the service to update"
    required: true
  environment:
    description: "The environment to update the plan with"
    required: true
  environment-type:
    description: "The type of environment to update the plan with"
    required: true
  working-directory:
    description: "Working directory for the action"
    required: false
    default: '.'

runs:
  using: "composite"
  steps:
    - name: Setup Omnistrate CTL
      uses: omnistrate-oss/setup-omnistrate-ctl@v1
      with:
        email: ${{ inputs.username }}
        password: ${{ inputs.password }}
        version: latest

    - name: Update plan using Omnistrate CTL
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "Updating plan with file: ${{ inputs.file }}"
        if [ "${{ inputs.working-directory }}" = "." ]; then
          FILE_PATH="${{ github.workspace }}/${{ inputs.file }}"
        else
          FILE_PATH="${{ github.workspace }}/${{ inputs.working-directory }}/${{ inputs.file }}"
        fi
        omctl build -f "$FILE_PATH" -n "${{ inputs.service-name }}" --environment "${{ inputs.environment }}" --environment-type "${{ inputs.environment-type }}" --release-as-preferred
